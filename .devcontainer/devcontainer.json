// This devcontainer assumes an external Postgres database
// (e.g. Supabase, RDS, or locally hosted), not a containerized DB.
// Connection auth is handled via the Postgres CLI and ~/.pgpass.

{
  "name": "Spring Boot & Postgres Dev Env",
  // The Universal image includes Java 17, Maven, and Node.js
  "image": "mcr.microsoft.com/devcontainers/universal:2",

  // // This installs the postgres-client tool during the build phase, not start-up.
  // "features": {
  //   "ghcr.io/devcontainers/features/postgres-client:1": {}
  // },

  "customizations": {
    "vscode": {
      "extensions": [
        // 1. Database Tools
        "ms-ossdata.vscode-postgresql",

        // 2. Java & Spring Boot Essentials
        "vscjava.vscode-java-pack",       // Includes Maven, Debugger, Test Runner
        "vmware.vscode-spring-boot",      // Spring Boot Tools
        "gabrielbb.vscode-lombok",        // CRITICAL: Makes Lombok annotations work in editor

        // 3. XML Tools (Helpful for editing pom.xml)
        "redhat.vscode-xml"
      ],
      "settings": {
        // Use the SDKMAN 'current' Java (currently Java 17 in the Universal image)
        "java.configuration.updateBuildConfiguration": "automatic",
        "java.jdt.ls.java.home": "/usr/local/sdkman/candidates/java/17.0.15-ms",
        "spring.boot.ls.java.home": "/usr/local/sdkman/candidates/java/17.0.15-ms",
        "pgsql.format.keywordCase": "upper"
      }
    }
  },

  // AUTOMATION EXPLAINED:
  // 1. apt-get update: Refreshes package lists (non-interactive mode prevents hangs).
  // 2. apt-get install: Gets the postgres client.
  // 3. sdk default: Switches the TERMINAL Java version to 17.
  // 4. Secret setup: Writes the password file if the secret exists.
  "postCreateCommand": "sudo DEBIAN_FRONTEND=noninteractive apt-get update && sudo DEBIAN_FRONTEND=noninteractive apt-get install -y postgresql-client && source /usr/local/sdkman/bin/sdkman-init.sh && sdk default java 17.0.15-ms && if [ -n \"$DB_PASSWORD\" ]; then echo \"*:*:*:*:$DB_PASSWORD\" > ~/.pgpass && chmod 0600 ~/.pgpass; else echo 'Warning: DB_PASSWORD not set'; fi"
}
