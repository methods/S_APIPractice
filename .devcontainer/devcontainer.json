// This devcontainer assumes an external Postgres database
// (e.g. Supabase, RDS, or locally hosted), not a containerized DB.
// Connection auth is handled via the Postgres CLI and ~/.pgpass.

{
  "name": "Spring Boot & Postgres Dev Env",
  // The Universal image includes Java 17, Maven, and Node.js
  "image": "mcr.microsoft.com/devcontainers/universal:2",

  // This installs the postgres-client tool during the build phase, not start-up.
  "features": {
    "ghcr.io/devcontainers/features/postgres-client:1": {}
  },

  "customizations": {
    "vscode": {
      "extensions": [
        // 1. Database Tools
        "ms-ossdata.vscode-postgresql",

        // 2. Java & Spring Boot Essentials
        "vscjava.vscode-java-pack",       // Includes Maven, Debugger, Test Runner
        "vmware.vscode-spring-boot",      // Spring Boot Tools
        "gabrielbb.vscode-lombok",        // CRITICAL: Makes Lombok annotations work in editor

        // 3. XML Tools (Helpful for editing pom.xml)
        "redhat.vscode-xml"
      ],
      "settings": {
        // Use the SDKMAN 'current' Java (currently Java 17 in the Universal image)
        "java.configuration.updateBuildConfiguration": "automatic",
        "java.jdt.ls.java.home": "/usr/local/sdkman/candidates/java/current",
        "spring.boot.ls.java.home": "/usr/local/sdkman/candidates/java/current",
        "pgsql.format.keywordCase": "upper"
      }
    }
  },

  // AUTOMATION
  // 1. Check if Secret env varible exists 
  // 2. Setup .pgpass (for external DB)
  // 3. (Optional) Run 'mvn clean install' to pre-download dependencies so the user waits less?
  //    (Usually better to let the user run this manually, but you *could* add it here).
  // This script only runs if your password secret is actually present.
  "postCreateCommand": "if [ -n \"$SUPABASE_DB_PASSWORD\" ]; then echo \"*:*:*:*:$SUPABASE_DB_PASSWORD\" > ~/.pgpass && chmod 0600 ~/.pgpass; else echo 'Warning: SUPABASE_DB_PASSWORD not set. .pgpass not created.'; fi"

}
